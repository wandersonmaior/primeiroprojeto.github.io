<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PythonClub, ">

        <link rel="alternate"  href="http://pythonclub.com.br/feeds/all.atom.xml" type="application/atom+xml" title="PythonClub Full Atom Feed"/>

    <link rel="shortcut icon" href="http://pythonclub.com.br/theme/images/favicon.ico" >

            <title>What the Flask? Pt-1 Introdução ao desenvolvimento web com Python - Bruno Cezar Rocha // PythonClub // </title>

    <meta property="fb:app_id" content="1487080281503641" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="What the Flask? Pt-1 Introdução ao desenvolvimento web com Python" />
    <meta property="og:site_name" content="PythonClub" />
    <meta property="og:url" content="http://pythonclub.com.br/what-the-flask-pt-1-introducao-ao-desenvolvimento-web-com-python.html" />
    <meta property="og:description" content="What The Flask - 1/6 6 passos para ser um Flask ninja! Nesta série de 6 artigos/tutoriais pretendo abordar de maneira bem detalhada o desenvolvimento web com o framework Flask. Depois de mais de um ano desenvolvendo projetos profissionais com o Flask e adquirindo experiência também no desenvolvimento do ..." />
    <meta property="og:image" content="http://res.cloudinary.com/diu8g9l0s/image/upload/v1400201393/pythonclub/logo_275x130.png" />

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://pythonclub.com.br/theme/css/pure.css">
    <link rel="stylesheet" href="http://pythonclub.com.br/theme/css/custom.css">
    <link rel="stylesheet" href="http://pythonclub.com.br/theme/css/pygments.css">



    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-50935105-1', 'pythonclub.com.br');
      ga('require', 'linkid', 'linkid.js');
      ga('send', 'pageview');

    </script>
</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="http://pythonclub.com.br/author/bruno-cezar-rocha.html" title="See posts by Bruno Cezar Rocha">
                        <img class="article-avatar" alt="Bruno Cezar Rocha" src="http://www.gravatar.com/avatar/9200c133c210ad51e8005277e932061a">
                </a>
                <h2 class="article-info">Bruno Cezar Rocha</h2>
    			<ul class="author-social">
                    <li>
                        <a target="_blank" href="https://www.gittip.com/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-gittip"></i>
                            <strong>Gittip</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://github.com/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-github"></i>
                            <strong>Github</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://bitbucket.org/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-bitbucket"></i>
                            <strong>Bitbucket</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="https://twitter.com/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-twitter"></i>
                            <strong>Twitter</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="http://www.linkedin.com/in/rochacbruno">
                            <i class="fa fa-lg fa-fw fa-linkedin"></i>
                            <strong>Linkedin</strong>
                        </a>
                    </li>
                    <li>
                        <a target="_blank" href="http://brunorocha.org">
                            <i class="fa fa-lg fa-fw fa-globe"></i>
                            <strong>Site</strong>
                        </a>
                    </li>
                </ul>
                <h5>Publicado em:</h5>
                <p>Sat 31 May 2014</p>
                <a href="/">&larr;Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>What the Flask? Pt-1 Introdução ao desenvolvimento web com Python</h1>
                        <p class="post-meta">
                            // Tags                                 <a class="post-category" href="http://pythonclub.com.br/tag/flask.html">flask</a>
                                <a class="post-category" href="http://pythonclub.com.br/tag/web.html">web</a>
                                <a class="post-category" href="http://pythonclub.com.br/tag/tutorial.html">tutorial</a>
                                <a class="post-category" href="http://pythonclub.com.br/tag/what-the-flask.html">what-the-flask</a>
                        </p>
                </header>
            </section>
            <h2>What The Flask - 1/6</h2>
<h3>6 passos para ser um Flask ninja!</h3>
<p>Nesta série de 6 artigos/tutoriais pretendo abordar de maneira bem detalhada
o desenvolvimento web com o framework Flask.</p>
<p>Depois de mais de um ano desenvolvendo projetos profissionais com o Flask e
adquirindo experiência também no desenvolvimento do projeto open source
<a href="http://quokkaproject.org">Quokka CMS</a> resolvi compartilhar algumas dicas
para facilitar a vida de quem pretende começar a desenvolver para web com Python.</p>
<blockquote>
<p><strong>TL;DR:</strong> A versão final do aplicativo explicado neste artigo está no <a href="https://github.com/rochacbruno/wtf">github</a></p>
</blockquote>
<p>A série <strong>W</strong>hat <strong>T</strong>he <strong>F</strong>lask será dividida nos seguintes capítulos.</p>
<ol>
<li><a href="/what_the_flask_introducao_ao_desenvolvimento_web_com_python.html"><strong>Hello Flask</strong></a>: Introdução ao desenvolvimento web com Flask  - <strong>&lt;-- Você está aqui</strong></li>
<li><strong>Flask patterns</strong>: boas práticas na estrutura de aplicações Flask</li>
<li><strong>Plug &amp; Use</strong>: extensões essenciais para iniciar seu projeto</li>
<li><strong>DRY</strong>: Criando aplicativos reusáveis com Blueprints</li>
<li><strong>from flask.ext import magic</strong>: Criando extensões para o Flask e para o Jinja2</li>
<li><strong>Run Flask Run</strong>: "deploiando" seu app nos principais web servers e na nuvem.</li>
</ol>
<h1>Hello Flask</h1>
<h3>Parte 1 - Introdução ao desenvolvimento web com Flask</h3>
<h4>Conhecendo o Flask</h4>
<ul>
<li><a href="#o_que_e_flask">O que é Flask</a></li>
<li><a href="#por_onde_comecar">Por onde começar</a></li>
<li><a href="#hello_world">Hello World</a></li>
<li><a href="#o_objeto_flask">O objeto Flask</a></li>
<li><a href="#views_e_roteamento_de_urls">Views e roteamento de urls</a></li>
<li><a href="#o_contexto_da_aplicacao">O contexto da aplicação</a></li>
<li><a href="#o_objeto_request_acessando_dados_via_get_e_post">O objeto "request" + acessando dados via GET e POST</a></li>
<li><a href="#sessoes_e_biscoitos">Sessões e biscoitos</a></li>
</ul>
<h4>Quick and Dirty Tutorial: Desenvolvendo um aplicativo de notícias</h4>
<ul>
<li><a href="#acessando_bando_de_dados_pequeno_exemplo_com_dataset">Acessando banco de dados (pequeno exemplo com dataset)</a></li>
<li><a href="#servindo_arquivos_estaticos">Servindo arquivos estáticos e upload de MEDIA</a></li>
<li><a href="#template_com_jinja_2">Templates com Jinja2</a></li>
</ul>
<blockquote>
<p><strong>ATENÇÃO:</strong> Este artigo é bem longo, então já coloca ai nos favoritos pois pode ser que não dê tempo de você terminar hoje :)</p>
</blockquote>
<h3><a name="o_que_e_flask" href="#o_que_e_flask">O que é Flask?</a></h3>
<p><img alt="Flask logo" src="http://flask.pocoo.org/static/logo.png" /></p>
<p>Flask é um micro-framework (um framework minimalista) desenvolvido em Python
e baseado em 3 pilares:</p>
<ul>
<li>
<p><a href="http://werkzeug.pocoo.org/">WerkZeug</a> é uma biblioteca para desenvolvimento de apps <a href="http://en.wikipedia.org/wiki/Web_Server_Gateway_Interface">WSGI</a> que é a especificação universal de como deve ser a interface entre um app Python e um web server. Ela possui a implementação básica deste padrão para interceptar requests e lidar com response, controle de cache, cookies, status HTTP, roteamento de urls e também conta com uma poderosa ferramenta de debug. Além disso o werkzeug possui um conjunto de <strong>utils</strong> que acabam sendo uma mão na roda mesmo em projetos que não são para a web.</p>
</li>
<li>
<p><a href="http://jinja.pocoo.org/">Jinja2</a> é um template engine escrito em Python, você escreve templates utilizando marcações como <code>{{ nome_da_variavel }}</code> ou <code>{% for nome in lista_de_nomes %} Hello {{nome}}!! {% endfor %}</code> e o Jinja se encarrega de renderizar este template, ou seja, ele substitui os placeholders pelo valor de suas variáveis.
O Jinja2 já vem com a implementação da maioria das coisas necessárias na construção de templates html e além disso é muito fácil de ser customizado com template filters, macros etc.</p>
</li>
<li>
<p><a href="https://trinket.io/python/fdedd0fb94">Good Intentions</a>: O Flask é <strong>Pythonico</strong>! além do código ter alta qualidade nos quesitos de legibilidade ele também tenta seguir as premissas do <a href="https://trinket.io/python/fdedd0fb94">Zen do Python</a> e dentro dessas boas intenções nós temos o fato dele ser um <a href="http://flask.pocoo.org/docs/foreword/#what-does-micro-mean"><strong>micro-framework</strong></a> deixando que você tenha liberdade de estruturar seu app da maneira que desejar. Tem os <a href="http://flask.pocoo.org/docs/patterns/">padrões de projeto e extensões</a> que te dão a certeza de que seu app poderá crescer sem problemas. Tem os sensacionais <a href="http://flask.pocoo.org/docs/blueprints/">Blueprints</a> para que você reaproveite os módulos que desenvolver. Tem o controverso uso de <a href="http://flask.pocoo.org/docs/advanced_foreword/#thread-locals-in-flask">Thread Locals</a> para facilitar a vida dos desenvolvedores. E além de tudo disso, não posso deixar de mencionar a comunidade que é bastante ativa e compartilha muitos projetos de extensões open-source como o Flask Admin, Flask-Cache, Flask-Google-Maps, Flask-Mongoengine, Flask-SQLAlchemy, Flask-Login, Flask-Mail etc....</p>
</li>
</ul>
<blockquote>
<p><strong>SUMMARY:</strong> o Flask não fica no seu caminho deixando você fluir com o desenvolvimento de seu app, você pode começar pequeno com um app feito em um único arquivo e ir crescendo aos poucos até ter seus módulos bem estruturados de uma maneira que permita a escalabilidade e o trabalho em equipe.</p>
</blockquote>
<h3><a name=por_onde_comecar href=#por_onde_comecar>Por onde começar?</a></h3>
<p>Obviamente que para seguir neste tutorial será necessário utilizar Python, não entrarei em detalhes sobre a instalação do Python neste artigo, mas com certeza aqui no <a href="/">PythonClub</a> devem ter artigos explicando detalhadamente a instalação do Python e a configuração de uma virtual-env, então vamos aos requirements.</p>
<h4>Você vai precisar de:</h4>
<ul>
<li><strong>Python 2.7</strong> (não usaremos Python 3 pois ainda tem extensões que não migraram)</li>
<li><strong>Ipython</strong> - Um terminal interativo (REPL) com poderes da super vaca ("Have you mooed today?")</li>
<li><strong>virtualenv</strong> ou <strong>virtualenv wrapper</strong> - para criação de ambientes isolados</li>
<li>Um <strong>editor</strong> de código ou IDE de sua preferência - (Gedit, Notepad++, sublime, Emacs, VIM etc..)</li>
<li>Um <strong>browser</strong> de verdade - espero que você não esteja usando o I.E :P</li>
<li><strong>Dataset</strong> - Biblioteca para acesso a bancos de dados</li>
<li><strong>Flask</strong> - Geralmente usado para armazenar vodka ou scotch (wtf?)</li>
</ul>
<h4>Ambiente</h4>
<p>Inicie criando uma pasta para o projeto no local de sua preferencia</p>
<p>(se preferir pode fazer via File Browser ou IDE)</p>
<div class="highlight"><pre>mkdir wtf
touch wtf/__init__.py
touch wtf/app.py
<span class="nb">cd </span>wtf
</pre></div>


<p>Agora crie uma <a href="http://virtualenv.readthedocs.org/en/latest/">virtualenv</a> para o projeto</p>
<p>Usando virtualenvwrapper <strong>(recommended)</strong></p>
<div class="highlight"><pre>sudo apt-get install virtualenvwrapper
mkvirtualenv wtf_env
</pre></div>


<p>Ou usando apenas virtualenv</p>
<div class="highlight"><pre>sudo apt-get install python-virtualenv
virtualenv wtf_env
<span class="nb">source </span>wtf_env/bin/activate
</pre></div>


<p>Com uma das opções acima o seu console agora deverá exibir algo como:</p>
<div class="highlight"><pre><span class="o">(</span>wtf_env<span class="o">)</span>seuuser@suamaquina/path/to/wtf<span class="err">$</span>
</pre></div>


<p>Instale o Flask e o Ipython</p>
<div class="highlight"><pre>pip install flask
pip install ipython
</pre></div>


<h3><a name="hello_world" href="#hello_world">Level 1.1 - Hello world</a></h3>
<p>Agora que o ambiente está pronto abra o arquivo <code>app.py</code> em seu editor favorito e vamos fazer o <strong>Hello World</strong> para começarmos bem o tutorial.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;Hello World! &lt;strong&gt;I am learning Flask&lt;/strong&gt;&quot;</span><span class="p">,</span> <span class="mi">200</span>

<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<p>Agora salve o arquivo e vá para o terminal e execute:</p>
<div class="highlight"><pre><span class="o">(</span>wtf_env<span class="o">)</span>seuuser@suamaquina/path/to/wtf<span class="nv">$ </span>python app.py
</pre></div>


<p>Abra o seu browser na url <a href="http://localhost:5000">http://localhost:5000</a> e você verá:</p>
<div style="border:1px solid black;padding:10px;">
 Hello World! <strong>I am learning Flask</strong>
</div>

<blockquote>
<p><strong>ACHIEVEMENT UNLOCKED!</strong> Se tudo ocorreu bem até aqui então parabéns! você passou para o level 1.2 e já pode se considerar um <strong>programador flask nível baby</strong> :)</p>
</blockquote>
<p>Nosso próximo passo será entender detalhadamente <strong>o que aconteceu</strong> nas 6 linhas que escrevemos no <code>app.py</code></p>
<h3>Level 1.2 - What The F**** happened here?</h3>
<h3><a name="o_objeto_flask" href="#o_objeto_flask">O objeto Flask</a></h3>
<p>Conforme mencionado no início deste artigo, o Flask utiliza como base o <strong>WerkZeug</strong> que é uma biblioteca WSGI. Para lidar com os recursos do WerkZeug precisamos de uma aplicação WSGI que é uma instância de um objeto Python que implemente o protocolo WSGI e possa ser servida pelos web servers que implementam este protocolo como o Gunicorn, Uwsgi, Apache mod_wsgi etc.</p>
<p>No Flask criamos a aplicação WSGI instanciando a classe <strong>Flask</strong>. O que essa classe faz é basicamente abstrair em métodos simples o fluxo de trabalho do padrão WSGI e do WerkZeug. Você pode ver como isto está implementado dando uma olhada no <a href="https://github.com/mitsuhiko/flask/blob/master/flask/app.py#L67">código fonte</a>.</p>
<div class="highlight"><pre>    <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>


<p>Nas duas linhas acima nós importamos a classe base do Flask e criamos uma instancia dela que chamamos de <strong>app</strong>, este <strong>app</strong> que é nossa aplicação WSGI que deverá ser passada para o servidor de aplicação que a estiver servindo.</p>
<blockquote>
<p><strong>BEST PRACTICE ADVICE:</strong> Especifique explicitamente o nome de seu pacote na hora de criar o app Flask, ao invés de <code>__name__</code> informe "nome_do_pacote".</p>
</blockquote>
<p>A classe Flask pode receber alguns parâmetros para instanciar o objeto <strong>app</strong> mas geralmente passamos apenas o <strong>import_name</strong> que deve ser o nome exato do pacote onde o <strong>app</strong> está definido. Você pode usar a variável <code>__name__</code> para pegar este valor dinâmicamente e você verá muitos exemplos assim, porém saiba desde já que isto <a href="https://github.com/mitsuhiko/flask/blob/master/flask/app.py#L98">não é uma boa prática</a>.</p>
<p>O Flask utiliza o <strong>import_name</strong> para definir o que pertence ao seu projeto e este nome é usado como base path para inferir os recursos como por exemplo descobrir onde fica a sua pasta de templates e sua pasta de arquivos estáticos.</p>
<p>Além disso a ferramenta de debug do Werkzeug te mostrará mensagens mais explicitas se você definir o nome do pacote de seu app.</p>
<p>Supondo que você criará a instancia no caminho <code>yourapplication/app.py</code> você tem essas 2 opções.</p>
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&#39;yourapplication&#39;</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<p>No ultimo caso o <code>__name__</code> seria <strong>yourapplication.app</strong> e por isso fazemos o split para se tornar <code>["yourapplication", "app"]</code> e então pegamos o primeiro elemento.</p>
<p>Eu recomendo usar o primeiro padrão pois é mais bonito :)</p>
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">)</span>
</pre></div>


<blockquote>
<p><strong>NOTE:</strong> O único caso onde uso do <code>__name__</code> é recomendado é quando seu projeto se resume a um único arquivo e não está contido em um pacote.</p>
</blockquote>
<h4>Qual a vantagem de criar apps desta maneira?</h4>
<p>Tem duas coisas interessantes nessa forma explicita de criar aplicações no Flask.</p>
<ol>
<li>
<p>Uma é o fato de que você pode e é inclusive <a href="http://flask.pocoo.org/docs/becomingbig/#subclass">encorajado</a> a criar suas próprias sub-classes Flask e isso te dá o poder de sobrescrever comportamentos básicos do framework como por exemplo forçar que tudo seja renderizado como JSON (Mas este é um tema que veremos com mais detalhes em outro capítulo).</p>
</li>
<li>
<p>Você pode ter mais de um app Flask em seu projeto e isto te garante reusabilidade e organização, vou dar um exemplo:</p>
</li>
</ol>
<div class="highlight"><pre><span class="c"># um arquivo projeto.py</span>

<span class="n">web_app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">rest_api</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s">&quot;path/to/different/folder&quot;</span><span class="p">)</span>

<span class="n">celery_app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">instance_path</span><span class="o">=</span><span class="s">&quot;blablabla&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FlaskCustomizedForSoap</span><span class="p">(</span><span class="n">Flask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Um Flask customizado para sempre responder um objeto SOAP válido&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">make_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returned_by_view</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;faça alguma coisa para nornalizar a</span>
<span class="sd">        resposta das views para o padrão SOAP&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">soapify</span><span class="p">(</span><span class="n">returned_by_view</span><span class="p">)</span>

<span class="n">soap_api</span> <span class="o">=</span> <span class="n">FlaskCustomizedForSoap</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>


<p>No exemplo acima temos em um único projeto 4 apps Flask que possuem papéis diferentes e podem ter configurações personalizadas ou até mesmo serem de uma subclasse do Flask customizada para algum tipo especifico de atividade como retornar dados no padrão <strike>SOAP</strike> (fique longe disso :P, use REST).</p>
<p>Neste caso para servir todas essas apps poderiamos usar o <a href="http://werkzeug.pocoo.org/docs/middlewares/#werkzeug.wsgi.DispatcherMiddleware">WerkZeug Dispatcher Middleware</a> para mapear as urls de cada app para um endpoint ou um dominio diferente.</p>
<blockquote>
<p><strong>RELAX:</strong> Nos próximos capítulos desta série entraremos em detalhes a respeito do Dispatcher e técnicas de organização e deploy.</p>
</blockquote>
<p>Como você pode perceber, ao instanciar o objeto Flask podemos passar vários argumentos na inicialização, não vou abordar com detalhes cada um desses argumentos, mas você pode conferir diretamente na <a href="http://flask.pocoo.org/docs/api/#application-object">documentação</a>.</p>
<h3><a name="views_e_roteamento_de_urls" href="#views_e_roteamento_de_urls">As views e o roteamento de urls</a></h3>
<h5>Views:</h5>
<p>Views são funções (ou classes) que respondem por uma determinada url, a função da view é capturar os paramêtros enviados pelo cliente via url e então efetuar o processamento necessário com o objetivo de responser com algum tipo de conteúdo ou mensagem de status que pode ser desde um texto plano, um texto com JSON, um stream de dados, um template html renderizado etc.</p>
<p>Por exemplo, se em um site de notícias o cliente requisitar via método <a href="http://pt.wikipedia.org/wiki/Hypertext_Transfer_Protocol#GET">GET</a> a seguinte url <code>http://localhost:8000/noticias/brasil?categoria=ciencia&amp;quantidade=2</code> precisamos primeiramente ter este <strong>endpoint</strong> <code>/noticias</code> mapeado para uma view no nosso sistema de rotas e dentro desta view pegaremos o argumento <strong>brasil</strong> e os parâmetros <strong>categoria</strong> e <strong>quantidade</strong> para utilizarmos para efetuar a busca em nosso banco de dados de notícias e então construir um retorno para exibir no navegador.</p>
<p>O Flask através do WerkZeug abstrai uma boa parte deste trabalho tornando isto uma tarefa bastante trivial, por baixo dos panos quando usamos o decorator <strong>@app.route</strong> na verdade estamos alimentando uma lista de mapeamento do Werkzeug implementada pelo <a href="http://werkzeug.pocoo.org/docs/routing/#quickstart">werkzeug.routing.Map</a> e esta lista de mapeamento contém elementos do tipo <strong>Rule</strong> que é justamente a regra que liga uma url com uma função Python em nosso projeto.</p>
<blockquote>
<p><strong>QUOTE:</strong> "Have you looked at werkzeug.routing? It's hard to find anything that's simpler, more self-contained, or purer-WSGI than Werkzeug, in general — I'm quite a fan of it!"  —  <a href="http://en.wikipedia.org/wiki/Alex_Martelli">Alex Martelli</a></p>
</blockquote>
<p>O Flask oferece 2 formas para o roteamento de views:</p>
<p>1 Roteamento via decorator</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias/&lt;pais&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lista_de_noticias</span><span class="p">(</span><span class="n">pais</span><span class="p">):</span>
    <span class="n">cat</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;categoria&quot;</span><span class="p">)</span>
    <span class="n">qtd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;quantidade&quot;</span><span class="p">)</span>
    <span class="n">noticias</span> <span class="o">=</span> <span class="n">BD</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">pais</span><span class="o">=</span><span class="n">pais</span><span class="p">,</span> <span class="n">categoria</span><span class="o">=</span><span class="n">cat</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">qtd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;lista_de_noticias.html&quot;</span><span class="p">,</span> <span class="n">noticias</span><span class="o">=</span><span class="n">noticias</span><span class="p">),</span> <span class="mi">200</span>

<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<blockquote>
<p><strong>TIP:</strong> Enquanto estiver desenvolvendo use <code>debug=True</code> para ativar o Werkzeug debugger e <code>use_reloader=True</code> para que o Flask dê um restart no servidor de desenvolvimento sempre que detectar alterar no código fonte.
(quando fizer deploy mude esses valores para False)</p>
</blockquote>
<p>A vantagem de rotear via decorator é que o Flask usará o nome de sua função automaticamente como <code>endpoint</code>, no exemplo acima <strong>lista_de_noticias</strong> seria o endpoint dessa view.</p>
<blockquote>
<p><strong>FLASKTIONARY:</strong> o termo <strong>endpoint</strong> serve para designar tanto um recurso de uma api via url, por exemplo <strong>api.site.com/users/new</strong>, mas no Flask ele também é utilizado para identificar o nome interno que o router usará para uma url especifica, exemplo: <strong>lista_noticias</strong>, isso serve para possa ser utilizada a função <code>url_for</code> para resolver urls dinâmicamente. <strong>RELAX:</strong> continuaremos falando sobre isso na parte de templates deste artigo</p>
</blockquote>
<p>Você pode inclusive utilizar multiplos decorators em uma mesma função para mapear várias urls, isto é útil para abranger uma mesma view com ou sem parametros.</p>
<p>exemplo:</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias&quot;</span><span class="p">)</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias/&lt;pais&gt;&quot;</span><span class="p">)</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias/&lt;pais&gt;/&lt;estado&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lista_de_noticias</span><span class="p">(</span><span class="n">pais</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">estado</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</pre></div>


<p>No exemplo acima a mesma view irá responder pelas urls <code>/noticias</code>, <code>/noticias/brasil</code> e <code>/noticias/brasil/sao-paulo</code></p>
<blockquote>
<p><strong>WARNING:</strong> Cuidado com o uso de multiplos decorators, a ordem em que são definidos é importante e caso esteja usando algum decorator customizado como por exemplo <code>@seu_app.requires_login</code>, se este for o primeiro decorator o Flask irá usar o nome da função wrapper do decorator ao invés do nome da view para o endpoint da url. A indicação é ao criar decorators utilizar sempre o <code>functools.wraps</code> para resolver este problema.</p>
</blockquote>
<p>2 Roteamento explicito</p>
<div class="highlight"><pre><span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s">&quot;/noticias/&lt;pais&gt;&quot;</span><span class="p">,</span>
                 <span class="n">endpoint</span><span class="o">=</span><span class="s">&quot;lista_noticias&quot;</span><span class="p">,</span>
                 <span class="n">view_func</span><span class="o">=</span><span class="n">lista_de_noticias</span><span class="p">)</span>
</pre></div>


<p>O caso acima é bastante útil quando você precisa automatizar ou centralizar o mapeamento de urls em um único local de seu projeto, é a maneira utilizada também com blueprints, a única desvantagem é que neste caso é sempre preciso informar explicitamente o nome do <strong>endpoint</strong> e a <strong>view_func</strong> a ser mapeada.</p>
<h4>Regras de URL</h4>
<p>As urls são recebidas no formato texto, por exemplo: <code>/noticias/1</code>, porém em alguns casos queremos que o valor passado como argumento seja convertido para um tipo de dados especifico, ou seja, queremos receber o <code>1</code> como um inteiro.</p>
<p>Você já sabe que o Flask utiliza o router do WerkZeug que internamente já implementa alguns <a href="http://werkzeug.pocoo.org/docs/routing/#builtin-converters">conversores</a> para as regras de url.</p>
<p>Os "conversores" padrão são:</p>
<ul>
<li><code>/noticias/&lt;categoria&gt;</code>, recebe o parâmetro "categoria" no formato unicode, exemplo "entretenimento".</li>
<li><code>/noticias/&lt;int:noticia_id&gt;</code>, recebe o parâmetro "noticia_id" no formato inteiro, exemplo: "1"</li>
<li><code>/cotacao/&lt;float:dolar&gt;/</code>, recebe o parâmetro "dolar" como float, exemplo: "3.2"</li>
<li><code>/imagem/&lt;path&gt;</code>, recebe o parâmetro "path" como um caminho, exemplo: "animais/marssupiais/quokka.png"</li>
</ul>
<p>Também é possivel utilizar <strong>regex</strong>, passar parâmetros para validação ou até mesmo criar seus próprios conversores de url, mas este assunto não veremos neste tutorial :(</p>
<h4>A barra no final da url</h4>
<p>Isto sempre causa certa confusão, portanto é sempre bom pensar um pouco antes de tomar esta decisão, sua url vai obrigar o uso da <strong>trailing backslash</strong> ou não?</p>
<p>No Flask existe uma convenção bastante útil: caso você declare sua url sem a barra no final <code>/noticias/&lt;categoria&gt;</code> então esta url será acessível apenas sem a barra no final. Agora se você deseja que a url <code>/noticias/entretenimento/</code> seja válida declare sua regra como <code>/noticias/&lt;categoria&gt;/</code> desta forma mesmo que o usuário esqueça de colocar a barra na hora de requisitar a url, o Flask irá automaticamente redirecionar o usuário para a url correta com a "/" no final.</p>
<blockquote>
<p><strong>TIP:</strong> Eu costumo utilizar uma lógica simples para decidir sobre o uso da "/", se a url define um recurso final da minha árvore de recursos, por exemplo, se a url é para uma imagem <code>/imagens/foto.jpg</code> ou se é para uma postagem de um site <code>/noticias/apenda-python.html</code> ou até mesmo <code>/noticias/aprenda-python</code>, então eu declaro a url sem a "/" no final. Porém se a url representa uma categoria, uma tag ou uma pasta então coloco a "/" no final pois desta forma segue o conceito de árvore, igual a árvore de arquivos e diretórios. Ex: <code>/noticias/entretenimento/</code> ou <code>/tags/python/</code>.</p>
</blockquote>
<h4>O retorno <strike style="color: red">de Jedi</strike> da view</h4>
<blockquote>
<p><strong>TIP:</strong> Pode ir escrevendo os códigos deste tutorial ai no <code>app.py</code> para ir testando enquanto lê este artigo.</p>
</blockquote>
<p>Views precisam retornar um objeto do tipo <strong>Response</strong> ou uma tupla formada por até 3 elementos, um <strong>body</strong> que pode ser um objeto serializável como por exemplo um texto, um inteiro representando o código de <strong>status HTTP</strong> e um dicionário de <strong>headers</strong>, sendo que os dois ultimos elementos são opcionais.</p>
<p>Exemplo:</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&lt;name&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;bruno&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Olá {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;Not Found&quot;</span><span class="p">,</span> <span class="mi">404</span>
</pre></div>


<p>Na view acima caso seja requisitada a url <code>localhost:5000/Bruno</code> o código de status será o "200" que representa "OK". Porém se requisitar informando um nome diferente o código de status será "404" com a mensagem "Not Found". Cada cliente pode implementar um comportamento diferente para o tratamento desses códigos de status, isto é muito importante principalmente quando trabalhamos com APIs.</p>
<blockquote>
<p><strong>RELAX:</strong> Se você não informar o código de status o Flask irá tentar resolver para você. Por padrão qualquer retorno no formato string é convertido para um objeto Response com código de status 200 e no header vai o Content-Type "text/html" automaticamente. Flask is full of magic :)</p>
</blockquote>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&lt;name&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;Olá {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>


<p>O exemplo acima também é válido, e neste caso o Flask irá informar automaticamente o código 200 ao menos que uma excessão HTTP seja levantada explicitamente ou por motivo de algum erro em seu código.</p>
<blockquote>
<p><strong>NOTE:</strong> Ao desenvolver uma API REST ou formulários que serão consumidos via Ajax é recomendado informar explicitamente os códigos HTTP e tratar adequadamente as excessões HTTP, pois do lado do cliente o comportamento pode depender desses códigos de status.</p>
</blockquote>
<p>Além disso o Flask oferece alguns <strong>helpers</strong> para facilitar o tratamento de excessões http, por exemplo o <strong>404</strong> ou <strong>503</strong> podem ser definidos através do helper <strong>abort</strong> e o <strong>301/302</strong> com o uso do helper <strong>redirect</strong>.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">abort</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/shortener/&lt;tiny_url&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">url_shortener</span><span class="p">(</span><span class="n">tiny_url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">banco_de_dados</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">shortened</span><span class="o">=</span><span class="n">tiny_url</span><span class="p">)</span><span class="o">.</span><span class="n">url</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c"># objeto NoneType não tem o atributo url, ou seja, não existe</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ConnectionError</span><span class="p">:</span>
        <span class="c"># não conseguiu conectar no MySQL # TODO: Use o PostGres :)</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">503</span><span class="p">)</span>  <span class="c"># ServiceUnavailable</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>


<p>O caso acima é a implementação de um encurtador de urls que procura uma url no banco de dados através de seu código ex: <code>/shortener/x56ty</code> e então utiliza 3 helpers para definir o status HTTP adequado, no melhor dos casos o usuário será redirecionado para a url <strong>desencurtada</strong>.</p>
<h4>HTML, JSON, XML etc</h4>
<p>HTML</p>
<p>Obviamente que você pode retornar conteúdo formatado e não apenas texto puro, isso poderá ser <strike style="color:red">feito direto na view</strike> ou em um <span style="color:green">template</span>.</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/html_page/&lt;nome&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">html_page</span><span class="p">(</span><span class="n">nome</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">    &lt;html&gt;</span>
<span class="s">       &lt;head&gt;&lt;title&gt;Ainda não sei usar o Jinja2 :)&lt;/title&gt;&lt;/head&gt;</span>
<span class="s">       &lt;body&gt;</span>
<span class="s">          &lt;h1&gt;Olá </span><span class="si">%s</span><span class="s"> Coisas que você não deve fazer.&lt;/h1&gt;</span>
<span class="s">          &lt;ul&gt;</span>
<span class="s">            &lt;li&gt; Escrever html direto na view &lt;/li&gt;</span>
<span class="s">            &lt;li&gt; Tentar automatizar a escrita de html via Python&lt;/li&gt;</span>
<span class="s">            &lt;li&gt; deixar de usar o Jinja2 &lt;/li&gt;</span>
<span class="s">          &lt;/ul&gt;</span>
<span class="s">       &lt;/body&gt;</span>
<span class="s">    &lt;/html&gt;</span>
<span class="s">    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">nome</span>
</pre></div>


<p>O exemplo acima apesar de em alguns raros casos ser útil, não é recomendado, o ideal é usar templates para deixar a camada de apresentação desacoplada da lógica do nosso app.</p>
<p>assumindo que o trecho html acima está em um arquivo <code>templates/html_page.html</code> podemos fazer o seguinte.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/html_page/&lt;nome&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">html_page</span><span class="p">(</span><span class="n">nome</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;html_page.html&quot;</span><span class="p">,</span> <span class="n">nome</span><span class="o">=</span><span class="n">nome</span><span class="p">)</span>
</pre></div>


<p>e dentro do arquivo html basta utilizar <code>{{nome}}</code> no lugar de <code>%s</code></p>
<blockquote>
<p><strong>RELAX:</strong> Logo mais falaremos a respeito dos templates</p>
</blockquote>
<p>JSON</p>
<p>Ao invés de retornar uma página HTML você poderá precisar retornar JSON, JSONP ou algum outro formato como <strike>XML</strike> arghhhhh.</p>
<p>Você pode simplesmente retornar uma string jsonificada porém também é preciso dizer ao cliente que o <strong>content_type</strong> ou <strong>mimetype</strong> em questão é <strong>application/json</strong>, <strike>m$/application:xml</strike> ou qualquer outro formato.</p>
<p>Existem 3 possibilidades:</p>
<p>Criar um objeto Response explicitamente</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>

<span class="k">def</span> <span class="nf">json_api</span><span class="p">():</span>
    <span class="n">pessoas</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Bruno Rocha&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Arjen Lucassen&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Anneke van Giersbergen&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Steven Wilson&quot;</span><span class="p">}]</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pessoas</span><span class="p">))</span>
    <span class="n">response</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="s">&quot;application/json&quot;</span>
    <span class="c"># ou</span>
    <span class="c"># response.headers[&#39;Content-Type&#39;] = &quot;application/json&quot;</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<p>Retornar uma tupla de 3 elementos, no formato <code>(string, status_code, headers_dict)</code></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">json_api</span><span class="p">():</span>
    <span class="n">pessoas</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Bruno Rocha&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Arjen Lucassen&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Anneke van Giersbergen&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Steven Wilson&quot;</span><span class="p">}]</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">pessoas</span><span class="p">),</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s">&quot;application/json&quot;</span><span class="p">}</span>
</pre></div>


<p>Os exemplos acima são válidos e poderão ser seguidos para outros tipos de dados, porém como JSON é um tipo de retorno muito comum o Flask já vem com um helper para ajuda-lo a economizar umas linhas de código.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span>

<span class="k">def</span> <span class="nf">json_api</span><span class="p">():</span>
    <span class="n">pessoas</span> <span class="o">=</span> <span class="p">[{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Bruno Rocha&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Arjen Lucassen&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Anneke van Giersbergen&quot;</span><span class="p">},</span>
               <span class="p">{</span><span class="s">&quot;nome&quot;</span><span class="p">:</span> <span class="s">&quot;Steven Wilson&quot;</span><span class="p">}]</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">pessoas</span><span class="o">=</span><span class="n">pessoas</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">pessoas</span><span class="p">))</span>
</pre></div>


<p>Com o uso de <strong>jsonify</strong> o Flask já se encarrega do header adequado e ainda valida a segurança no formato do JSON, além disso fica muito mais bonito o código.</p>
<h3><a name="o_contexto_da_aplicacao" href="#o_contexto_da_aplicacao">The application context</a></h3>
<blockquote>
<p><strong>NOTE:</strong> Esta é uma questão um pouco complexa, eu não vou tentar explicar em detalhes e vou apenas abordar os pontos importantes de forma bem resumida e simplificada, caso tenha interesse em entender mais a fundo pode dar uma lida nos <a href="http://flask.pocoo.org/docs/appcontext/">docs</a> a respeito.</p>
</blockquote>
<p>Existem 3 estados em que uma app Flask pode estar:</p>
<h4>1 Estado de configuração.</h4>
<p>É quando a app é instanciada, e nenhum request ocorreu ainda, é o momento em que você pode seguramente modificar as configurações e carregar módulos, extensões etc.</p>
<p>Este estado ocorre antes do <strong>dispatch</strong>, ou seja, no nosso caso é antes do <strong>app.run()</strong> ser executado, mas no caso de servir seu app com outro app server como gunicorn ou uwsgi este estado é antes do servidor WSGI registrar o objeto <strong>application</strong>.</p>
<p>Exemplo:</p>
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;SECRET_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;schblaums&quot;</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&quot;DEBUG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

<span class="kn">from</span> <span class="nn">flask.ext.magic</span> <span class="kn">import</span> <span class="n">MakeMagic</span>
<span class="n">MakeMagic</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>


<p>As linhas acima "ocorrem" geralmente no estado de configuração e portanto assumimos que <strong>não</strong> existe um <strong>request</strong> em andamento. Um detalhe importante é o fato de que este estado é válido apenas para o <strong>top level</strong> module, ou seja, dentro do escopo de funções, views, classes etc o estado será outro.</p>
<h4>2 Estado de request</h4>
<p>É quando seu app já foi iniciado e está <strong>registrado</strong> no servidor WSGI e então acontece uma requisição (algum cliente acessa uma url), neste momento o Flask irá popular o objeto request com os dados desta requisição e você poderá acessar o objeto request.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/show_config&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_config</span><span class="p">():</span>
    <span class="n">querystring_args</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">post_args</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DEBUG&#39;</span><span class="p">),</span>
        <span class="n">args</span><span class="o">=</span><span class="n">querystring_args</span><span class="p">,</span>
        <span class="nb">vars</span><span class="o">=</span><span class="n">post_args</span>
    <span class="p">)</span>
</pre></div>


<p>No exemplo acima acessamos os valores do objeto request, tanto os passados via GET(querystring) tanto quanto os passados via POST (formulário). Além disso acessamos a <strong>current_app</strong> para pegar as configs da app em execução. O <strong>current_app</strong> existe pois no Flask é possível ter mais de um objeto Flask em um único projeto e portanto precisamos de uma forma dinâmica de acessar o app em execução.</p>
<p>Mais de um app em um único projeto:</p>
<blockquote>
<p><strong>It's weird</strong></p>
</blockquote>
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">outra_app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/url_na_app&quot;</span><span class="p">)</span>
<span class="nd">@outra_app.route</span><span class="p">(</span><span class="s">&quot;/url_na_outra_app&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view</span><span class="p">():</span>
    <span class="o">....</span>

<span class="k">if</span> <span class="n">X</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">elif</span> <span class="n">Y</span><span class="p">:</span>
    <span class="n">outra_app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>


<p>O exemplo acima é meio non-sense mas é possível, além disso para fazer este tipo de coisa é recomendado usar o dispatcher middleware.</p>
<h4>3 Estado interativo ou estado de testes</h4>
<p>As vezes para efetuar pequenos testes ou até mesmo escrever testes unitários é necessário acessar o objeto <strong>request</strong> ou o <strong>current_app</strong> em um script standalone ou em um terminal interativo.</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">request</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
<span class="o">...</span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">working</span> <span class="n">outside</span> <span class="n">of</span> <span class="n">request</span> <span class="n">context</span>
</pre></div>


<p>Nesta hora você pensa <strong>WTF</strong> terei que fazer um request cada vez que precisar testar esse código? não, calma, o Flask oferece uma solução.</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">request</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">&quot;/teste&quot;</span><span class="p">,</span> <span class="s">&quot;x.com&quot;</span><span class="p">,</span> <span class="s">&quot;aaa=1&amp;bb=2&quot;</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span>

<span class="p">{</span><span class="s">&#39;aaa&#39;</span><span class="p">:</span> <span class="s">u&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;bb&#39;</span><span class="p">:</span> <span class="s">u&#39;2&#39;</span><span class="p">}</span>
<span class="s">u&quot;/teste&quot;</span>
</pre></div>


<p>Enfim, usamos o gerenciador de contexto <code>app.test_request_context</code> para fazer um <strong>mock</strong> de um request real que será usado apenas para fins de testes.</p>
<h2><a name="o_objeto_request_acessando_dados_via_get_e_post" href="#o_objeto_request_acessando_dados_via_get_e_post">O objeto "request" + acessando dados via GET e POST</a></h2>
<p>O objeto <strong>request</strong> é um <strong>proxy</strong> global que internamente garante você acesse a requisição atual ou *thread-local atual. Ele carrega dados referentes a cada requisição HTTP, nele podemos acessar as variáveis enviadas atráves da url ou de um formulário, podemos também verificar o método HTTP entre outros dados importantes que podem ser conferidos na <a href="http://flask.pocoo.org/docs/api/#incoming-request-data">doc</a>.</p>
<p>Os itens mais importantes são: (method, args, form, path, is_json)</p>
<p>É muito útil checar qual o método HTTP que foi requisitado, isto é o que possibilita a criação de uma API REST, o exemplo a seguir é auto explicativo:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticia&quot;</span><span class="p">)</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticia/&lt;int:noticia_id&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">noticia_api</span><span class="p">(</span><span class="n">noticia_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;GET&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">noticia_id</span><span class="p">:</span>
            <span class="c"># retorna uma noticia especifica</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">noticia</span><span class="o">=</span><span class="n">noticias</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># retorna todas as noticias</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">noticias</span><span class="o">=</span><span class="n">noticias</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_json</span><span class="p">:</span>
            <span class="c"># se o request veio com o mimetype &quot;json&quot; usa os dados para</span>
            <span class="c"># inserir novas noticias</span>
            <span class="n">noticias</span><span class="o">.</span><span class="n">bulk_insert</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;Noticias inseridas com sucesso&quot;</span><span class="p">,</span> <span class="mi">201</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># assumimos que os dados vieram via Ajax/POST/Formulário</span>
            <span class="n">noticias</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;Noticia criada com sucesso&quot;</span><span class="p">,</span> <span class="mi">201</span>
    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;DELETE&quot;</span> <span class="ow">and</span> <span class="n">noticia_id</span><span class="p">:</span>
        <span class="c"># apaga uma noticia especifica</span>
        <span class="n">noticias</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Noticia apagada com sucesso!&quot;</span><span class="p">,</span> <span class="mi">204</span>
    <span class="o">...</span>
</pre></div>


<blockquote>
<p><strong>WAIT:</strong> O exemplo acima é apenas uma das formas de se fazer isso, e não é a forma mais recomendada. É preferivel o uso de geradores de API como o Python-EVE ou o Flask-API. Além disso também é possível utilizar class based Method views para melhorar o código, mas veremos isso em um próximo capítulo.</p>
</blockquote>
<h3>Valores mais importantes do objeto <strong>request</strong></h3>
<ul>
<li>request.<strong>method</strong>: Informa qual método HTTP foi usado na requisiçao</li>
<li>request.<strong>headers</strong>: headers HTTP da requisição, útil para checar o mimetype e dados de basic auth.</li>
<li>request.<strong>environ</strong>: Variáveis de ambiente do WSGI, navegador, ip do cliente etc</li>
<li>request.<strong>path</strong>, request.url: O path ou a url completa da requisição</li>
<li>request.<strong>is_xhr</strong>: Informa se é ou não uma requisição Ajax</li>
<li>request.<strong>blueprint</strong>: Nome do blueprint que interceptou o request, Blue o que? -- Calma, veremos o que é isso mais adiante</li>
</ul>
<h3>Acessando dados do request</h3>
<h4>request.args</h4>
<p>Um dicionário com os valores passados via GET (na url após o ?).</p>
<p>url requisitada: <code>/noticias?categoria=esportes&amp;limit=10</code></p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span>
<span class="n">ImmutableMultiDict</span><span class="p">([(</span><span class="s">&#39;categoria&#39;</span><span class="p">,</span> <span class="s">u&#39;esportes&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;limit&#39;</span><span class="p">,</span> <span class="s">u&#39;10&#39;</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="p">{</span><span class="s">u&quot;categoria&quot;</span><span class="p">:</span> <span class="s">u&quot;esportes&quot;</span><span class="p">,</span> <span class="s">u&quot;limit&quot;</span><span class="p">:</span> <span class="s">u&quot;10&quot;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;categoria&quot;</span><span class="p">)</span>
<span class="s">u&quot;esportes&quot;</span>
</pre></div>


<p>Não é muito comum mas em alguns casos as chaves podem se repetir, neste caso devemos usar o <code>getlist</code>.</p>
<p>url requisitada: <code>/noticias?categoria=esportes&amp;categoria=musica</code></p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span>
<span class="n">ImmutableMultiDict</span><span class="p">([(</span><span class="s">&#39;categoria&#39;</span><span class="p">,</span> <span class="s">u&#39;esportes&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;categoria&#39;</span><span class="p">,</span> <span class="s">u&#39;musica&#39;</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c"># mantém só os primeiros</span>
<span class="p">{</span><span class="s">u&quot;categoria&quot;</span><span class="p">:</span> <span class="s">u&quot;esportes&quot;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&quot;categoria&quot;</span><span class="p">)</span>
<span class="p">[</span><span class="s">u&quot;esportes&quot;</span><span class="p">,</span> <span class="s">u&quot;musica&quot;</span><span class="p">]</span>
</pre></div>


<h4>request.form</h4>
<p>O request.form funciona da mesma forma que o .args porém ele intercepta apenas os argumentos passados via POST, PUT ou PATCH, ou seja, via formulário ou payload.</p>
<p>exemplo de requisição POST via console</p>
<div class="highlight"><pre>curl --data <span class="s2">&quot;categoria=esportes&amp;limit=10&quot;</span> http://localhost:5000/noticias
</pre></div>


<p>A requisição acima corresponde ao submit de um formulário contento os campos "categoria" e "limit".</p>
<div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
<span class="n">ImmutableMultiDict</span><span class="p">([(</span><span class="s">&#39;categoria&#39;</span><span class="p">,</span> <span class="s">u&#39;esportes&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;limit&#39;</span><span class="p">,</span> <span class="s">u&#39;10&#39;</span><span class="p">)])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="p">{</span><span class="s">u&quot;categoria&quot;</span><span class="p">:</span> <span class="s">u&quot;esportes&quot;</span><span class="p">,</span> <span class="s">u&quot;limit&quot;</span><span class="p">:</span> <span class="s">u&quot;10&quot;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;categoria&quot;</span><span class="p">)</span>
<span class="s">u&quot;esportes&quot;</span>
</pre></div>


<p>repare que é exatamente o mesmo funcionamento do .args</p>
<h4>request.json</h4>
<p>É exatamente a mesma coisa do .args e do .form, porém ele será populado quando o request trouxer o mimetype "application/json", então os dados do JSON no payload serão colocados neste atributo.</p>
<p>Requisição</p>
<div class="highlight"><pre>curl -X POST -d <span class="o">{</span><span class="s2">&quot;categoria&quot;</span>: <span class="s2">&quot;esporte&quot;</span><span class="o">}</span> http://localhost:5000/noticias --header <span class="s2">&quot;Content-Type:application/json&quot;</span>
</pre></div>


<p>O restante é igual, basta usar o <code>request.is_json</code> para checar se a requisição é com JSON payload e então acessar os dados.</p>
<h4>request.files / file uploads</h4>
<p>Caso seu formulário ou API permitam o envio de arquivos esses dados serão colocados no <code>request.files</code>. Isto ocorre pois internamente o Flask transforma os dados recebidos em um objeto <strong>FileStorage</strong> para permitir que você manipule os com mais facilidade.</p>
<p>Requisição: (equivale a um formulário com file upload)</p>
<div class="highlight"><pre>curl --form <span class="s2">&quot;photo=@picture.jpg&amp;item_id=12345&quot;</span> http://localhost:5000/change_photo
</pre></div>


<p>para salvar a imagem:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/change_photo&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">perfil</span><span class="p">():</span>
    <span class="n">item_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;item_id&#39;</span><span class="p">)</span>
    <span class="n">photo</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;photo&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item_id</span> <span class="ow">and</span> <span class="n">photo</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">photo</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">banco_de_dados</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item_id</span><span class="o">=</span><span class="n">item_id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">photo_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&quot;Imagem atualizada&quot;</span><span class="p">,</span> <span class="mi">201</span>
</pre></div>


<blockquote>
<p><strong>TIP:</strong> Sempre utilize o helper <strong>secure_filename</strong> do Werkzeug pois ele sanitiza a url removendo caracteres indesejados e evitando dor de cabeça com file system.</p>
</blockquote>
<h3><a name="sessoes_e_biscoitos" href="#sessoes_e_biscoitos"> Sessions and Cookies</a></h3>
<p>Antes de falar de "Session" precisamos falar de "Cookies", pois um não vive sem o outro! &lt;3</p>
<p>Cookie é um "storage" de dados que é armazenado pelo cliente (browser, etc), os cookies trafegam via HTTP header e você pode ler e escrever cookies.</p>
<p>Existe uma série de <a href="http://en.wikipedia.org/wiki/HTTP_cookie">especificações</a> a respeito, mas não entrarei nos detalhes, vamos apenas ver como manipula-los no Flask.</p>
<h4>Escrevendo em um biscoito! (estranho isso né?)</h4>
<p>Para escrever dados em um cookie usamos o objeto <strong>Response</strong>, portanto sempre que precisar escrever um cookie será necessário criar explicitamente um objeto <strong>Response</strong> para este fim.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span><span class="p">,</span> <span class="n">make_response</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_login</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="s">&quot;Hello! Welcome back!&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">&#39;user_hash&#39;</span><span class="p">,</span> <span class="n">get_hash</span><span class="p">(</span><span class="n">username</span><span class="p">))</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
</pre></div>


<p>No exemplo acima validamos o username e o password e caso o usuário seja válido gravamos algumas informações no cookie.</p>
<blockquote>
<p><strong>DUMMY CODE ALERT:</strong> O código acima é apenas um exemplo tosco, para controlar acesso recomendo o uso de Flask-Login ou Flask-Security</p>
</blockquote>
<h4>Lendo o biscoito (da sorte?)</h4>
<p>Bom, assumindo que temos as informações <strong>username</strong> e <strong>user_hash</strong> gravadas no browser do cliente, e que este enviará este cookie no HEADER a cada requisição que fizer, podemos facilmente ler os dados contidos no cookie através do objeto <strong>request</strong>.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
    <span class="n">user_hash</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_hash&#39;</span><span class="p">)</span>
    <span class="c"># request.cookies é um dict, portanto use o .get para evitar KeyError</span>
    <span class="k">if</span> <span class="n">is_logged</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">user_hash</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Welcome!&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">))</span>
</pre></div>


<p>Neste outro <strong>DUMMY CODE</strong> pegamos os dados que recebemos do cookie e usamos para veriricar se o usuário está logado ou algo do tipo.</p>
<h4>Sessions</h4>
<p>No Flask existe o objeto <strong>session</strong> que é também uma forma de armazenar informação que será persistida entre requests, na <strong>session</strong> você pode armazenar informações de controle de acesso e até mesmo preferencias do usuário.</p>
<p>As sessions dependem dos cookies, pois são indexadas atráves de um <strong>SESSION_ID</strong> que por padrão é sempre gravado em um cookie. Além disso o Flask por padrão guarda tembém os dados da <strong>session</strong> nos cookies, ou seja, os dados ficam lá do lado cliente, porém ele utiliza criptografia nesses dados, é possível visualizar o conteúdo deste cookie mas para alterar é sempre preciso assina-lo com a chave de criptografia correta e é para isso que serve a configuração <strong>SECRET_KEY</strong> lá nos config de seu app Flask.</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">request</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SECRET_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;A0Zr98j/3yX R~XHH!jmN]LWX/,?RT&quot;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">if</span> <span class="s">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;OLá, você está logado como </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">escape</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">))</span>

<span class="c"># O escape() precisa ser usado apenas se você não estiver usando um template.</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span>
<span class="s">            &lt;p&gt;&lt;input type=text name=username&gt;</span>
<span class="s">            &lt;p&gt;&lt;input type=submit value=Login&gt;</span>
<span class="s">        &lt;/form&gt;</span>
<span class="s">    &#39;&#39;&#39;</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c"># Apaga os dados de login lá da session</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
</pre></div>


<blockquote>
<p><strong>TIP:</strong> Você pode armazenar as sessions em outro local diferente dos cookies se desejar, isto é útil quando você precisa manipular as sessions do lado servidor ou quando quer por exemplo saber quantos usuários estão com sessões abertas. Pode ser no memcached, banco SQL, redis ou MongoDB por exemplo. Uma ótima extensão para fazer isso é o <a href="https://github.com/mbr/flask-kvsession">Flask-KVsession</a> baseado no simplekv.</p>
</blockquote>
<h3><a name="acessando_bando_de_dados_pequeno_exemplo_com_dataset" href="#acessando_bando_de_dados_pequeno_exemplo_com_dataset"> Acessando banco de dados (pequeno exemplo com dataset)</a></h3>
<p>Uma das vantagens do Flask é o fato dele não estar limitado a um ORM especifico para lidar com banco de dados, você poderá escolher entre SQlAlchemy, Peewee, Pony, MongoEngine etc. Você pode também fazer tudo na <strong>unha</strong> usando mysql-python ou Pymongo se preferir, enfim, a escolha é sua!</p>
<p>Em outro capítulo desta série mostrarei exemplos com o MongoEngine, mas nesta parte introdutória vamos usar o módulo <a href="https://github.com/pudo/dataset">dataset</a> que é uma camada de abstração para ler e escrever dados nos bancos SQLite, MySQL ou Postgres.</p>
<p>A vantagem do dataset é que ele é incrivelmente simples, não exige especificação de <strong>schema</strong> e é puro Python.</p>
<p>Para começar instale o <strong>dataset</strong> na sua virtualenv.</p>
<div class="highlight"><pre><span class="o">(</span>wtf_env<span class="o">)</span>seuuser@suamaquina/path/to/wtf<span class="nv">$ </span>pip install dataset
</pre></div>


<blockquote>
<p><strong>NOTE:</strong> O dataset vai instalar várias dependencias, entre elas estão o <strong>alembic</strong> para efetuar migrations automáticas e o <strong>SQLAlchemy</strong> para conexão e mapeamento.</p>
</blockquote>
<h3>Escrevendo no banco de dados</h3>
<p>agora na raiz do projeto vamos criar um arquivo novo chamado <code>db.py</code>.</p>
<div class="highlight"><pre><span class="c"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">dataset</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&#39;sqlite:///noticias.db&#39;</span><span class="p">)</span>
<span class="n">noticias</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">&#39;noticias&#39;</span><span class="p">]</span>
</pre></div>


<p>Agora crie um arquivo <code>news_app.py</code> e vamos inicialmente criar uma view contendo um formulário para <strong>cadastro de novas notícias</strong>.</p>
<blockquote>
<p><strong>NOTE:</strong> Inicialmente não vamos nos preocupar com segurança, csrf ou login, mas nos próximos capítulos desta sério iremos evoluir este pequeno app.</p>
</blockquote>
<div class="highlight"><pre><span class="c"># coding: utf-8</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span>

<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">noticias</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">)</span>

<span class="c"># por enquanto vamos usar um template html hardcoded</span>
<span class="c"># mas calma! em breve falaremos  sobre os templates com Jinja2</span>
<span class="n">base_html</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">  &lt;html&gt;</span>
<span class="s">  &lt;head&gt;</span>
<span class="s">      &lt;title&gt;{title}&lt;/title&gt;</span>
<span class="s">  &lt;/head&gt;</span>
<span class="s">  &lt;body&gt;</span>
<span class="s">     {body}</span>
<span class="s">  &lt;/body&gt;</span>
<span class="s">  &lt;/html&gt;</span>
<span class="s">&quot;&quot;&quot;</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias/cadastro&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">cadastro</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">dados_do_formulario</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">nova_noticia</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dados_do_formulario</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">            &lt;h1&gt;Noticia id </span><span class="si">%s</span><span class="s"> inserida com sucesso!&lt;/h1&gt;</span>
<span class="s">            &lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt; Inserir nova notícia &lt;/a&gt;</span>
<span class="s">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nova_noticia</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;cadastro&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c"># GET</span>
        <span class="n">formulario</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">           &lt;form method=&quot;post&quot; action=&quot;/noticias/cadastro&quot;&gt;</span>
<span class="s">               &lt;label&gt;Titulo:&lt;br /&gt;</span>
<span class="s">                    &lt;input type=&quot;text&quot; name=&quot;titulo&quot; id=&quot;titulo&quot; /&gt;</span>
<span class="s">               &lt;/label&gt;</span>
<span class="s">               &lt;br /&gt;</span>
<span class="s">               &lt;label&gt;Texto:&lt;br /&gt;</span>
<span class="s">                    &lt;textarea name=&quot;texto&quot; id=&quot;texto&quot;&gt;&lt;/textarea&gt;</span>
<span class="s">               &lt;/label&gt;</span>
<span class="s">               &lt;input type=&quot;submit&quot; value=&quot;Postar&quot; /&gt;</span>
<span class="s">           &lt;/form&gt;</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">base_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">u&quot;Inserir nova noticia&quot;</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">formulario</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>Salve e execute seu aplicativo <code>python news_app.py</code> e acesse <a href="http://localhost:5000/noticias/cadastro">http://localhost:5000/noticias/cadastro</a></p>
<p>Você verá um formulário com os campos <strong>titulo</strong> e <strong>texto</strong>, insira uma notícia nova e repita o processo algumas vezes. Note que na raiz de seu projeto agora terá um banco de dados SQLite <strong>noticias.db</strong>.</p>
<h3>Lendo do banco de dados</h3>
<p>Abra o arquivo <code>news_app.py</code> e após a linha 39 vamos incluir uma view para listar todas as notícias na home do site.</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="n">noticia_template</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">        &lt;a href=&quot;/noticia/{noticia[id]}&quot;&gt;{noticia[titulo]}&lt;/a&gt;</span>
<span class="s">    &quot;&quot;&quot;</span>

    <span class="c"># it&#39;s a kind of magic :)</span>
    <span class="n">todas_as_noticias</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">noticia_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">noticia</span><span class="o">=</span><span class="n">noticia</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">noticia</span> <span class="ow">in</span> <span class="n">noticias</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">base_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">u&quot;Todas as notícias&quot;</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="s">u&quot;&lt;br /&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">todas_as_noticias</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>


<p>Agora ao acessar <a href="http://localhost:5000">localhost:5000</a> Você verá uma lista de links com os títulos das notícias que cadastrou!</p>
<p>Só falta agora uma última view que será a utilizada para exibir a notícia quando você clicar no link.</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticia/&lt;int:noticia_id&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">noticia</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">):</span>
    <span class="n">noticia</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">)</span>  <span class="c"># query no banco de dados</span>
    <span class="n">noticia_html</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">        &lt;h1&gt;{titulo}&lt;/h1&gt;</span>
<span class="s">        &lt;p&gt;{texto}&lt;/p&gt;</span>
<span class="s">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">noticia</span><span class="p">)</span>  <span class="c"># remember, Python is full of magic!</span>

    <span class="k">return</span> <span class="n">base_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">noticia</span><span class="p">[</span><span class="s">&#39;titulo&#39;</span><span class="p">],</span> <span class="n">body</span><span class="o">=</span><span class="n">noticia_html</span><span class="p">)</span>
</pre></div>


<p>Seu app de cadastro e leitura de notícias está pronto!</p>
<p>A versão completa pode ser encontrada <a href="https://gist.github.com/rochacbruno/5ed42779bbb8d7738d71">neste link</a>, salve o arquivo e execute <code>python news_app.py</code> acesse <a href="http://localhost:5000">localhost:5000</a> e agora você terá a lista de notícias e poderá clicar em cada uma delas para ler seu conteúdo.</p>
<blockquote>
<p><strong>CALMA:</strong> Falta muita coisa ainda, ainda precisa de login, segurança contra csrf, sanitizar o html da notícia, permitir que a notícia seja alterada e etc..</p>
</blockquote>
<h3><a name="servindo_arquivos_estaticos" href="#servindo_arquivos_estaticos"> Servindo arquivos estáticos</a></h3>
<p>Arquivos estáticos são todos os arquivos que você deseja entregar ao cliente sem a necessidade de processar, ou seja, sem a necessidade de efetuar nenhum tipo de computação dentro do Flask.</p>
<p>Geralmente arquivos JavaScript, CSS, imagens, videos, documentos etc são incluidos nesta categoria. Para evitar o <strong>overhead</strong> de processamento ao servir estes arquivos o <strong>ideal</strong> é sempre delegar esta tarefa ao servidor web que estiver sendo usado, isto é fácil de ser feito no Nginx e também no Apache, para isso esses servidores mapeiam um padrão de url, por exemplo todas as urls contendo:  <code>/static/*.[jpg|png|gif|css...]</code> e servem estes arquivos diretamente sem passar pelo servidor de palicação (o WSGI).</p>
<p>Porém durante o desenvolvimento você vai precisar servir estes arquivos enquanto testa, para isso o Flask implementa um endpoint especifico que pode ser configurado ao iniciar a aplicação e também oferece um template tag que ajuda a resolver esse caminho dinamicamente nos templates.</p>
<blockquote>
<p><strong>TIP:</strong> É possivel definir um endpoint dinâmico para os arquivos estáticos e desta forma hospedar em um CDN ou em serviços externos como Amazon S3, Akamai ou Dropbox.</p>
</blockquote>
<h4>Definindo a pasta e o endpoint dos arquivos estáticos</h4>
<p>No arquivo <code>wtf/news_app.py</code> da nossa app de notícias criarmos uma instância a app com <code>Flask('wtf')</code> sem passar nenhum parâmetro adicional, neste caso o Flask irá assumir o comportamento default que é ter uma pasta de estáticos localizada em <code>wtf/static</code> e o endpoint de estáticos mapeado para <code>/static/</code> e na maioria dos casos esta convenção irá atender perfeitamente.</p>
<p>Caso você precise especificar um caminho diferente para os arquivos físicos ou um mapeamento de url diferente poderá informar ao Flask através dos seguintes parâmetros:</p>
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s">&#39;assets&#39;</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s">&quot;assets_v1&quot;</span><span class="p">)</span>
</pre></div>


<p>No exemplo acima agora os arquivos estáticos deverão ficar em uma pasta <code>wtf/assets</code> e a url para acessa-los será <code>localhost:8000/assets_v1/arquivo.ext</code> ao invés de <code>/static/arquivo.ext</code>.</p>
<h4>Mão na massa</h4>
<p>Crie uma nova pasta <code>wtf/static</code> e salve o seguinte arquivo dentro dela</p>
<p>Clique com o botão direito do mouse e escolha "salvar imagem..."</p>
<p><img alt="https://jobs.github.com/images/modules/company/generic_logo.gif" src="https://jobs.github.com/images/modules/company/generic_logo.gif" /></p>
<p>Agora modifique o <code>news_app.py</code> e vamos exibir este logotipo na página inicial, para isso primeiro altere o <code>base_html</code> incluindo o placeholder <code>{{logo_url}}</code>.</p>
<div class="highlight"><pre><span class="n">base_html</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">  &lt;html&gt;</span>
<span class="s">  &lt;head&gt;</span>
<span class="s">      &lt;title&gt;{title}&lt;/title&gt;</span>
<span class="s">  &lt;/head&gt;</span>
<span class="s">  &lt;body&gt;</span>
<span class="s">     &lt;img src=&quot;{logo_url}&quot; /&gt;</span>
<span class="s">     &lt;hr /&gt;</span>
<span class="s">     {body}</span>
<span class="s">  &lt;/body&gt;</span>
<span class="s">  &lt;/html&gt;</span>
<span class="s">&quot;&quot;&quot;</span>
</pre></div>


<p>Agora altere o retorno das views incluindo a variavel <strong>logo_url</strong>, por exemplo na view <code>cadastro</code> altere para:</p>
<div class="highlight"><pre>        <span class="k">return</span> <span class="n">base_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">u&quot;Inserir nova noticia&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">formulario</span><span class="p">,</span>
            <span class="n">logo_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">&#39;generic_logo.gif&#39;</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>


<p>Repita o procedimento para as outras 2 views incluindo o trecho <code>logo_url=url_for('static', filename='generic_logo.gif')</code> no .format.</p>
<p>O helper <code>url_for</code> criou dinâmicamente uma url completa apontando par ao nosso arquivo estático, e se por acaso mudarmos os valores de static_folder e static_path não teremos que nos preocupar com a mudança das urls em nossos templates html pois o uso do endpoint especial <strong>static</strong> no url_for garante isso.</p>
<blockquote>
<p><strong>TIP:</strong> Os preguiçosos podem baixar o <a href="https://gist.github.com/rochacbruno/71e874ac18177b22a31a">arquivo</a>.</p>
</blockquote>
<h4>Gravando e servindo arquivos de MEDIA</h4>
<p>Geralmente chamamos de arquivos de MEDIA aqueles arquivos que não fazem parte da estrutura do nosso site, enquanto os css e js e também imagens do layout e logotipos são fixos de nossa estrutura. Uma foto de um usuário ou um documento .doc ou .pdf anexado a uma notícia são contéudo dinâmico que precisaremos servir do mesmo modo que servimos os arquivos estáticos.</p>
<p>Resolver isso no Flask é uma tarefa relativamente fácil, vamos começar com os uploads de arquivos.</p>
<h4>Upload de arquivos</h4>
<p>Agora para cada notícia o usuário também poderá incluir uma imagem, vamos implementar o upload desta imagem.</p>
<p>Inicialmente crie uma nova pasta <code>wtf/media_files</code> e edite as primeiras linhas do <code>news_app.py</code> incluindo a configuração do local onde os arquivos de media serão armazenados.</p>
<div class="highlight"><pre><span class="c"># coding: utf-8</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span>

<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">noticias</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">)</span>

<span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s">&#39;media_files&#39;</span><span class="p">)</span>
</pre></div>


<p>A config "MEDIA_ROOT" irá guardar o caminho absoluto para a pasta <code>../wtf/media_files</code></p>
<p>Agora edite a view de cadastro de notícias:</p>
<ol>
<li>inclua <code>enctype="multipart/form-data"</code> no html do formulário para permitir uploads.</li>
<li>Insira um campo para upload de arquivo</li>
<li>importe o <code>current_app</code> para poder acessar os configs da app em execução e o `secure_filename`` para garantir um nome válido para o upload</li>
<li>implemente o upload da imagem utilizando o <code>request.files</code> e salve o caminho da imagem junto com a notícia</li>
</ol>
<div class="highlight"><pre><span class="o">...</span>

<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">current_app</span>

<span class="o">...</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias/cadastro&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">cadastro</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="n">dados_do_formulario</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">imagem</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;imagem&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imagem</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">imagem</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MEDIA_ROOT&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">imagem</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dados_do_formulario</span><span class="p">[</span><span class="s">&#39;imagem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">nova_noticia</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dados_do_formulario</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">            &lt;h1&gt;Noticia id </span><span class="si">%s</span><span class="s"> inserida com sucesso!&lt;/h1&gt;</span>
<span class="s">            &lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt; Inserir nova notícia &lt;/a&gt;</span>
<span class="s">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nova_noticia</span><span class="p">,</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;cadastro&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c"># GET</span>
        <span class="n">formulario</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">           &lt;form method=&quot;post&quot; action=&quot;/noticias/cadastro&quot;</span>
<span class="s">             enctype=&quot;multipart/form-data&quot;&gt;</span>
<span class="s">               &lt;label&gt;Titulo:&lt;br /&gt;</span>
<span class="s">                    &lt;input type=&quot;text&quot; name=&quot;titulo&quot; id=&quot;titulo&quot; /&gt;</span>
<span class="s">               &lt;/label&gt;</span>
<span class="s">               &lt;br /&gt;</span>
<span class="s">               &lt;label&gt;Texto:&lt;br /&gt;</span>
<span class="s">                    &lt;textarea name=&quot;texto&quot; id=&quot;texto&quot;&gt;&lt;/textarea&gt;</span>
<span class="s">               &lt;/label&gt;</span>
<span class="s">               &lt;br /&gt;</span>
<span class="s">               &lt;label&gt; Imagem:&lt;br /&gt;</span>
<span class="s">                  &lt;input type=&quot;file&quot; name=&quot;imagem&quot; id=&quot;imagem&quot; /&gt;</span>
<span class="s">               &lt;/label&gt;</span>
<span class="s">               &lt;input type=&quot;submit&quot; value=&quot;Postar&quot; /&gt;</span>
<span class="s">           &lt;/form&gt;</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">base_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">u&quot;Inserir nova noticia&quot;</span><span class="p">,</span>
            <span class="n">body</span><span class="o">=</span><span class="n">formulario</span><span class="p">,</span>
            <span class="n">logo_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">&#39;generic_logo.gif&#39;</span><span class="p">)</span>
        <span class="p">)</span>
</pre></div>


<p>Com isso pode acessar <a href="http://localhost:5000/noticias/cadastro">localhost:5000/noticias/cadastro</a> e inserir uma notícia com imagem!</p>
<p>Se preferir faça <a href="https://gist.github.com/rochacbruno/00adfb0145797fb95c76">download</a> da versão completa do <code>news_app.py</code></p>
<h4>Servindo os arquivos de media</h4>
<p>Agora vamos fazer com que a imagem inserida na notícia seja mostrada na página dela junto com o seu texto. Nós já vimos que o Flask tem um endpoint <strong>static</strong> para servir os arquivos estáticos da pasta padrão, porém no nosso caso os arquivos estão localizados em outra pasta, a <strong>media_files</strong>, teremos que criar uma view para servir estes arquivos.</p>
<p>Comece importando a fuinção <code>send_from_directory</code> lá no inicio do <code>news_app.py</code></p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">send_from_directory</span>
</pre></div>


<p>Agora vamos incluir uma nova view após a linha 104:</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/media/&lt;path:filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">media</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MEDIA_ROOT&#39;</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
</pre></div>


<p>Esta view será responsável por pegar o arquivo do diretório e fazer stream para o cliente. O próximo passo e construir a url usando o endpoint <strong>media</strong> que é o nome da view.</p>
<p>Altere a view <strong>noticia</strong> incluindo a imagem no html e resolvendo a url para a imagem correspondente com o url_for, caso a notícia não possua imagem usaremos uma imagem padrão.</p>
<div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticia/&lt;int:noticia_id&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">noticia</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">):</span>
    <span class="n">noticia</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">)</span>  <span class="c"># query no banco de dados</span>
    <span class="k">if</span> <span class="n">noticia</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;imagem&#39;</span><span class="p">):</span>
        <span class="n">imagem_url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&#39;media&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">noticia</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;imagem&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imagem_url</span> <span class="o">=</span> <span class="s">&quot;http://placehold.it/100x100&quot;</span>

    <span class="n">noticia_html</span> <span class="o">=</span> <span class="s">u&quot;&quot;&quot;</span>
<span class="s">        &lt;h1&gt;{titulo}&lt;/h1&gt;</span>
<span class="s">        &lt;img src=&quot;{imagem_url}&quot;&gt;</span>
<span class="s">        &lt;hr /&gt;</span>
<span class="s">        &lt;p&gt;{texto}&lt;/p&gt;</span>
<span class="s">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">imagem_url</span><span class="o">=</span><span class="n">imagem_url</span><span class="p">,</span>
        <span class="o">**</span><span class="n">noticia</span>
    <span class="p">)</span>  <span class="c"># remember, Python is full of magic!</span>

    <span class="k">return</span> <span class="n">base_html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">noticia</span><span class="p">[</span><span class="s">&#39;titulo&#39;</span><span class="p">],</span>
        <span class="n">body</span><span class="o">=</span><span class="n">noticia_html</span><span class="p">,</span>
        <span class="n">logo_url</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">&#39;generic_logo.gif&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>


<p>Faça o <a href="https://gist.github.com/rochacbruno/27fc63e46966aeca89a0">download</a> da versão com exibição de imagens.</p>
<p>Agora acesse as noticias que cadastrou com imagem para visualizar a imagem junto com a notícia. :)</p>
<h3><a name="template_com_jinja_2" href="#template_com_jinja_2"> Templates com Jinja2</a></h3>
<p>Até agora escrevemos HTML diretamente em strings no <code>news_app.py</code>, porém conforme o app vai crescendo começa a ficar impossível dar manutenção nesses templates hardcoded, sem contar que é mais interessante ter isso em uma camada separada possibilitando a substituição a qualquer momento.</p>
<p>No Flask você até pode escolher utilizar um outro engine de templates como o Mako, Genshi, TAL etc, porém o padrão implementado no <strong>render_template</strong> do Flask é o Jinja2.</p>
<p>O Jinja2 foi inspirado na sintaxe do sistema de templates do Django e é muito fácil de utilizar. Para este nosso app de notícias você precisará saber apenas alguns conceitos do Jinja2, mas no decorrer desta série exploraremos outros assuntos mais avançados como criação de macros, template loaders e extensões.</p>
<h4>Base template</h4>
<p>Todo site tem um layout comum que se repete em todas as páginas, geralmente onde fica a barra superior, os menus, o logotipo e o rodapé. Para não precisar ficar repetindo essa parte do código no template de todas as páginas é comum criarmos um base template e depois ir estendendo ele nos outros templates.</p>
<p>Exemplo:</p>
<p>base.html</p>
<div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
    {% block topo %}
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;logo.png&quot;</span><span class="nt">&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;menu&gt;&lt;ul&gt;&lt;li&gt;</span>HOME<span class="nt">&lt;/li&gt;&lt;li&gt;</span>CADASTRO<span class="nt">&lt;/li&gt;&lt;/ul&gt;&lt;/menu&gt;</span>
    {% endblock %}
    <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
    {% block content%}<span class="c">&lt;!-- page content --&gt;</span>{% endblock%}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>Repare que no exemplo acima usamos a tag <code>{% block &lt;block_name&gt; %}</code> para definir uma area no template que poderá ser sobrescrita pelos templates que estenderem o template base.</p>
<h4>Estendendo o template base</h4>
<p>Agora imagine que vamos criar o template que vai exibir a lista de notícias.</p>
<div class="highlight"><pre>{% extends &quot;base.html&quot; %}
{% block content %}
    <span class="nt">&lt;ul&gt;</span>
       {% for noticia in noticias %}
           <span class="nt">&lt;li&gt;</span>{{noticia[&#39;titulo&#39;]}}<span class="nt">&lt;/li&gt;</span>
       {% endfor %}
    <span class="nt">&lt;/ul&gt;</span>
{% endblock %}
</pre></div>


<p>Repare desta vez que não foi necessário reescrever o html básico e nem o bloco do menu, apenas sobrescrevemos o bloco <strong>content</strong> e dentro dele montamos a lista de notícias.</p>
<p>O Jinja2 aceita um subset limitado da linguagem Python, ou seja, você pode usar Python nos templates, mas não pode fazer qualquer coisa. O mais indicado é que você limite-se a usar o básico que são os loops e as expressões condicionais, além é claro dos statements da própria linguagem de templates.</p>
<p>No Jinja os statements do template engine, as tags customizadas e código Python devem ficar entre "{%" e "%}". Já a "impressão" de valores no html é feita entre "{{" e "}}", sendo que esta sintaxe pode até ser customizada para qualquer outra combinação que você preferir.</p>
<p>Uma outra caracteristica interessante é que nos templates chaves de dicionários podem ser acessadas via <strong>.</strong> ou via <strong>[ ]</strong> os dois casos funcionam. exemplo: <code>{{ noticia['titulo'] }}</code> ou <code>{{ noticia.titulo }}</code></p>
<h4>definindo a pasta de templates</h4>
<p>Assim como no caso dos estáticos o Flask já tem um padrão que é sempre procurar os templates em uma pasta chamada <code>templates</code> mas você pode alterar este caminho se preferir.</p>
<div class="highlight"><pre><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&#39;wtf&#39;</span><span class="p">,</span> <span class="n">templates_folder</span><span class="o">=</span><span class="s">&#39;outra_pasta_de_templates&#39;</span><span class="p">)</span>
</pre></div>


<p>No nosso caso vamos utilizar o padrão e criar uma nova pasta <code>wtf/templates</code> e dentro desta pasta crie um novo arquivo chamado <code>wtf/templates/base.html</code> e vamos usa-lo para substituir a variavel <code>base_html</code> no <code>news_app.py</code>.</p>
<p>Crie orquivo <code>templates/base.html</code> e apague a variavel <code>base_html</code> do <code>news_app.py</code></p>
<div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>{% block title %} {{title or &quot;Notícias&quot;}} {% endblock %}<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
   <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{url_for(&#39;static&#39;, filename=&#39;generic_logo.gif&#39;)}}&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;nav&gt;</span>
       <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url_for(&#39;index&#39;)}}&quot;</span><span class="nt">&gt;</span>HOME<span class="nt">&lt;/a&gt;</span> | <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url_for(&#39;cadastro&#39;)}}&quot;</span><span class="nt">&gt;</span>CADASTRO<span class="nt">&lt;/a&gt;</span>
   <span class="nt">&lt;/nav&gt;</span>
   <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
   {% block content %} {% endblock %}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>Desta maneira podemos utilizar o helper <strong>url_for</strong> direto no template para acessar os arquivos estáticos. Repare também que fizemos uma impressão condicional em <code>{{ title or "Notícias"}}</code> isso é possível pois no Jinja2 qualquer variável não existente é avaliada como <strong>None</strong>, este mesmo trecho poderia ser escrito da seguinte maneira <code>{{ title|default("Notícias") }}</code></p>
<p>Agora vamos criar um template para a home do site, onde a lista de notícias é exibida.</p>
<p>Crie o arquivo <code>templates/index.html</code></p>
<div class="highlight"><pre>{% extends &quot;base.html&quot; %}
{% block content %}
<span class="nt">&lt;ul&gt;</span>
    {% for noticia in noticias %}
    <span class="nt">&lt;li&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url_for(&#39;noticia&#39;, noticia_id=noticia.id)}}&quot;</span><span class="nt">&gt;</span>
         {{noticia.titulo}}
        <span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
    {% endfor %}
<span class="nt">&lt;/ul&gt;</span>
{% endblock %}
</pre></div>


<p>Neste exemplo utilizamos um loop <code>for</code> para iterar sobre a lista de noticias que será passada pela view, também usamos o url_for para criar a url que levará para a página de leitura da notícia.</p>
<p>Agora crie agora o template da página da notícia em <code>templates/noticia.html</code></p>
<div class="highlight"><pre>{% extends &quot;base.html&quot; %}
{% block title%}
    {{noticia.titulo}}
{% endblock%}

{% block content %}
    <span class="nt">&lt;h1&gt;</span>{{noticia.titulo}}<span class="nt">&lt;/h1&gt;</span>
    {% if noticia.imagem %}
        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ url_for(&#39;media&#39;, filename=noticia.imagem) }}&quot;</span> <span class="na">width=</span><span class="s">&quot;300&quot;</span> <span class="nt">/&gt;</span>
    {% endif %}
    <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;p&gt;</span>
        {{noticia.texto}}
    <span class="nt">&lt;/p&gt;</span>
{% endblock %}
</pre></div>


<p>Agora falta apenas o template para o formulário de cadastro de nova notícia e basta copiar e colar o html da variavel formulário para um template chamado <code>templates/cadstro.html</code> e fazer pequenas alterações.</p>
<div class="highlight"><pre>{% extends &quot;base.html&quot; %}
{% block content %}
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;{{ url_for(&#39;cadastro&#39;) }}&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;label&gt;</span>Titulo:<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;titulo&quot;</span> <span class="na">id=</span><span class="s">&quot;titulo&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;/label&gt;</span>
   <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;label&gt;</span>Texto:<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;texto&quot;</span> <span class="na">id=</span><span class="s">&quot;texto&quot;</span><span class="nt">&gt;&lt;/textarea&gt;</span>
   <span class="nt">&lt;/label&gt;</span>
   <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;label&gt;</span> Imagem:<span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;imagem&quot;</span> <span class="na">id=</span><span class="s">&quot;imagem&quot;</span> <span class="nt">/&gt;</span>
   <span class="nt">&lt;/label&gt;</span>
   <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Postar&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
{% endblock %}
</pre></div>


<p>Vamos criar também um template para exibir uma mensagem de sucesso ao inserir nova notícia em <code>templates/cadastro_sucesso.html</code></p>
<div class="highlight"><pre>{% extends &quot;base.html&quot; %}
{% block title %}
    Notícia {{id_nova_noticia}} inserida com sucesso
{% endblock %}

{% block content %}
    <span class="nt">&lt;h1&gt;</span>Notícia {{id_nova_noticia}} inserida com sucesso!<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url_for(&#39;noticia&#39;, noticia_id=id_nova_noticia)}}&quot;</span><span class="nt">&gt;</span> Ler Notícia <span class="nt">&lt;/a&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;{{url_for(&#39;cadastro&#39;)}}&quot;</span><span class="nt">&gt;</span> Cadastrar nova notícia <span class="nt">&lt;/a&gt;</span>
{% endblock %}
</pre></div>


<p>Após salvar os 5 arquivos de template base.html, index.html, noticia.html, cadastro.html e cadastro_sucesso.html dentro da pasta templates, altere o <code>news_app.py</code> para usar a função <strong>render_template</strong> que recebe como parâmetros o nome do template e as variaveis que estarão disponíveis no escopo do template.</p>
<div class="highlight"><pre><span class="c"># coding: utf-8</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">current_app</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">render_template</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">noticias</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="s">&quot;wtf&quot;</span><span class="p">)</span>

<span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MEDIA_ROOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s">&#39;media_files&#39;</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticias/cadastro&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">cadastro</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>

        <span class="n">dados_do_formulario</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">imagem</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;imagem&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imagem</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">imagem</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MEDIA_ROOT&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">imagem</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">dados_do_formulario</span><span class="p">[</span><span class="s">&#39;imagem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">id_nova_noticia</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">dados_do_formulario</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;cadastro_sucesso.html&#39;</span><span class="p">,</span>
                                <span class="n">id_nova_noticia</span><span class="o">=</span><span class="n">id_nova_noticia</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;cadastro.html&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">u&quot;Inserir nova noticia&quot;</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">todas_as_noticias</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;index.html&#39;</span><span class="p">,</span>
                           <span class="n">noticias</span><span class="o">=</span><span class="n">todas_as_noticias</span><span class="p">,</span>
                           <span class="n">title</span><span class="o">=</span><span class="s">u&quot;Todas as notícias&quot;</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/noticia/&lt;int:noticia_id&gt;&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">noticia</span><span class="p">(</span><span class="n">noticia_id</span><span class="p">):</span>
    <span class="n">noticia</span> <span class="o">=</span> <span class="n">noticias</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">noticia_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;noticia.html&#39;</span><span class="p">,</span> <span class="n">noticia</span><span class="o">=</span><span class="n">noticia</span><span class="p">)</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/media/&lt;path:filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">media</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MEDIA_ROOT&#39;</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>Após salvar os templates e o news_app.py modificado reinicie o serviço flask no terminal usando CTRL+C e executando novamente <code>python news_app.py</code>. Isso é necessário pois o Flask cria o cache de templates no momento da inicialização do aplicativo.</p>
<p>Acesse o app via <a href="http://localhost:5000">localhost:5000</a> e veja que agora a barra de menu se mantém em todas as páginas.</p>
<p>O aplicativo completo pode ser obtido no <a href="https://github.com/rochacbruno/wtf">repositorio do github</a>.</p>
<blockquote>
<p><strong>END:</strong> Sim chegamos ao fim desta primeira parte da série <strong>W</strong>hat <strong>T</strong>he <strong>F</strong>lask. Eu espero que você tenha aproveitado as dicas aqui mencionadas. Nas próximas 5 partes iremos nos aprofundar em boas práticas, uso e desenvolvimento de extensões e blueprints e também questṍes relacionados a deploy de aplicativos Flask. Acompanhe o PythonClub, o meu <a href="http://brunorocha.org">site</a> e meu <a href="http://twitter.com/rochacbruno">twitter</a> para ficar sabendo quando a próxima parte for publicada.</p>
</blockquote>
<hr />

<blockquote>
<p><strong>PUBLICIDADE:</strong> Estou iniciando um curso online de Python e Flask, para iniciantes abordando com muito mais detalhes e exemplos práticos os temas desta série de artigos e muitas outras coisas envolvendo Python e Flask, o curso será oferecido no CursoDePython.com.br, ainda não tenho detalhes especificos sobre o valor do curso, mas garanto que será um preço justo e acessível. Caso você tenha interesse por favor preencha este <a href="https://docs.google.com/forms/d/1qWx4pzNVSPQmxsLgYBjTve6b_gGKfKLMSkPebvpMJwg/viewform?usp=send_form">formulário</a> pois dependendo da quantidade de pessoas interessadas o curso sairá mais rapidamente.</p>
</blockquote>
<hr />

<blockquote>
<p><strong>PUBLICIDADE 2:</strong> Também estou escrevendo um livro de receitas <strong>Flask CookBook</strong> através da plataforma LeanPub, caso tenha interesse por favor preenche o formulário na <a href="https://leanpub.com/pythoneflask">página do livro</a></p>
</blockquote>
<p>Muito obrigado e aguardo seu feedback com dúvidas, sugestões, correções ou bitcoins (LOL) na caixa de comentários abaixo.</p>
<p>Abraço! "Python é vida!"</p>
            <div class="sharing">
                <!-- Facebook sharing -->
                <div id="fb-root"></div>
                <script>(function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/pt_BR/sdk.js#xfbml=1&appId=1487080281503641&version=v2.0";
                fjs.parentNode.insertBefore(js, fjs);
                }(document, 'script', 'facebook-jssdk'));</script>
                <div class="fb-share-button" data-href="http://pythonclub.com.br/what-the-flask-pt-1-introducao-ao-desenvolvimento-web-com-python.html" data-type="button_count"></div>

                <!-- Google+ sharing -->
                <div class="g-plus alinhar" data-action="share" data-annotation="bubble" data-href="http://pythonclub.com.br/what-the-flask-pt-1-introducao-ao-desenvolvimento-web-com-python.html"></div>

                <!-- Twitter sharing -->
                <a href="https://twitter.com/share" class="twitter-share-button" data-lang="pt" style="margin-bottom: -4px !important;">Tweetar</a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            </div>

            <div class="hr"></div>
            <a href="#" class="go-top">Topo</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "pythonclub"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div><footer class="footer">
    <p>&copy; PythonClub &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>


    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/fitvids/1.0.1/jquery.fitvids.min.js"></script>
    <script>
        $(document).ready(function(){
            $(".content").fitVids();
        });
        $(window).load(function(){
          $("iframe").css("margin-bottom", "-6px")
          $("#twitter-widget-0").css("margin-bottom", "-5px");
          $("#twitter-widget-0").css("margin-left", "-1px");
        });
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/platform.js">
      {lang: 'pt-BR'}
    </script>

    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });
    </script>
</body>
</html>