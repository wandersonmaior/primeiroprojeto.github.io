<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>PythonClub</title><link>http://pythonclub.com.br/</link><description></description><atom:link href="http://pythonclub.com.br/feeds/romulo-collopy.rss.xml" rel="self"></atom:link><lastBuildDate>Tue, 13 May 2014 16:00:00 -0300</lastBuildDate><item><title>Publicação de projetos com o Django-Fagungis</title><link>http://pythonclub.com.br/deploy-com-django-fagungis.html</link><description>&lt;h2&gt;Django-Fagungis&lt;/h2&gt;
&lt;h3&gt;O que é?&lt;/h3&gt;
&lt;p&gt;Django-Fagungis é um projeto original do &lt;a href="http://github.com/dnx"&gt;Denis Darii&lt;/a&gt;, &lt;a href="https://pypi.python.org/pypi/django-fagungis/0.0.17"&gt;disponível no Pypi para instalação via pip&lt;/a&gt;. A idéia do projeto é simples: automatizar o deploy de projetos Django para servidores com acesso root, utilizando o &lt;a href="http://www.fabfile.org/"&gt;Fabric&lt;/a&gt;, uma biblioteca e ferramenta de linha de comando em Python (2.5-2.7) que usa o protocolo SSH para o deploy de aplicações e realização de tarefas administrativas no sistema, não restrita a projetos Python.&lt;/p&gt;
&lt;p&gt;Porém, nesse artigo, &lt;strong&gt;não vamos usar a versão original do Django-Fagungis&lt;/strong&gt;. Em vez dela, &lt;strong&gt;usaremos um fork&lt;/strong&gt; feito por &lt;a href="https://github.com/damianmoore/"&gt;Damian Moore&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Por isso, a instalação não será feita diretamente pelo pip, mas pelo repositório do Damian, em &lt;a href="https://github.com/damianmoore/django-fagungis"&gt;https://github.com/damianmoore/django-fagungis&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;pip install git+https://github.com/damianmoore/django-fagungis.git&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pediu a senha de root? Que tal criar um virtualenv primeiro?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Atualmente, trabalho mais com Python3 que com Python2, porém o Fabric ainda não foi completamente portado para o Python3, por isso, sempre crio um virtualenv para trabalhar com ele.&lt;/p&gt;
&lt;p&gt;No caso do Django-Fagungis creio que você tem um argumento a mais para usar um virtualenv: existem forks mais atuais que o projeto disponóvel no pip e possivelmente você vai querer testar diferentes versões.&lt;/p&gt;
&lt;h3&gt;Então, vamos ao passo a passo.&lt;/h3&gt;
&lt;p&gt;Digamos que você queira criar um projeto chamado simpleproject, em Python3, em um virtualenv. (Eu vou usar ~/dev/simpleproject).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;mkdir -p ~/dev/simpleproject.com
cd ~/dev/simpleproject
pip install --upgrade virtualenv
virtualenv --unzip-setuptools --python=/usr/bin/python3.4 .
source bin\activate
pip install django
django-admin.py startproject simpleproject .
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;Oops&lt;/strong&gt;, temos um problema, pois o fabric não suporta o Python3. Então criamos outro virtualenv para o django-fagungis. Você pode fazer isso em qualquer lugar. Nesse exemplo vou instalar em:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;~/dev/tools/django-fagungis-damianmoore&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Notem que deixei o nome do usuário github na pasta para lembrar que estou usando um fork.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Agora vou até a pasta e crio o virtualenv com Python2&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;deactivate
mkdir -p ~/dev/tools/django-fagungis-damianmoore
cd ~/dev/tools/django-fagungis-damianmoore
virtualenv --unzip-setuptools --python=/usr/bin/python2.7 .
source bin\activate
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;Pode ser que você não precise dizer o caminho do executável do python para a versão 2.7&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;E instalo o django-fagungis::&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;pip install git+https://github.com/damianmoore/django-fagungis.git
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;E copio o fabfile.py de exemplo para meu projeto:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;cp ~/dev/tools/django-fagungis-damianmoore/lib/python2.7/site-packages/fagungis/example_fabfile.py ~/dev/simpleproject/fabfile.py
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Feito isso, podemos voltar ao projeto e editar o fabfile para as configurações do seu projeto. A configuração é bem simples e o arquivo é autoexplicativo.&lt;/p&gt;
&lt;p&gt;Seu projeto deverá estar em um repositório, seja ele no bitbicket, github, ou qualquer lugar onde seu servidor possa acessá-lo (e com as devidas permissões). Nesse caso, vou supor que seu projeto está no github:&lt;/p&gt;
&lt;p&gt;Mude
&lt;code&gt;def example():&lt;/code&gt; para &lt;code&gt;def simpleproject():&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;E as variáveis env.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;env.project = &amp;#39;simpleproject_production&amp;#39;
env.repository = &amp;#39;https://github.com/seu-username/simpleproject.git&amp;#39;
env.repository_type = &amp;#39;git&amp;#39;
env.hosts = [&amp;#39;root@simpleproject.org&amp;#39;, ]
env.additional_packages = [&amp;#39;git-core&amp;#39;,]
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;Agora, algumas configurações mais sensíveis:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;O Django e o Nginx têm um tratamento particular para a url static, por isso a automatixação fica mais fácil se você não usar essa url no seu projeto.&lt;/p&gt;
&lt;p&gt;Dê preferência para usar configurações como a seguir:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;#  django media url and root dir
env.django_media_url = &amp;#39;/media/&amp;#39;
env.django_media_root = env.code_root
#  django static url and root dir
env.django_static_url = &amp;#39;/assets/&amp;#39;
env.django_static_root = env.code_root
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;E, em seu settings.py &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;unipath&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;
&lt;span class="n"&gt;PROJECT_ROOT&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;__file__&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parent&lt;/span&gt;

&lt;span class="c"&gt;#...&lt;/span&gt;

&lt;span class="n"&gt;STATIC_URL&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s"&gt;&amp;#39;/assets/&amp;#39;&lt;/span&gt;
&lt;span class="n"&gt;STATIC_ROOT&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;PROJECT_ROOT&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;parent&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;child&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;assets&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;Se você escolheu usar Python3&lt;/strong&gt; no seu projeto, adicione o path para o python3 no virtenv_options&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;env.virtenv_options = [&amp;#39;distribute&amp;#39;, &amp;#39;no-site-packages&amp;#39;,&amp;#39;python=/usr/bin/python3&amp;#39;, ]
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Estamos com tudo quase pronto. Você já pode tentar o deploy do seu projeto, mas para isso terá que ativar o virtualenv onde instalou o django-fagungis. Como esse processo é um pouco chato, criei um script para fazer isso e voltar para o seu projeto. &lt;/p&gt;
&lt;p&gt;Crie um arquivo fagungis.sh e grave na pasta onde ele está instalado (&lt;code&gt;~/dev/tools/django-fagungis-damianmoore&lt;/code&gt; em nosso caso)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;SCRIPT_NAME=&amp;quot;&lt;span class="cp"&gt;${&lt;/span&gt;&lt;span class="n"&gt;BASH_SOURCE&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="cp"&gt;}&lt;/span&gt;&amp;quot;
SCRIPT_DIR=&amp;quot;$( dirname &amp;quot;&lt;span class="nv"&gt;$SCRIPT_NAME&lt;/span&gt;&amp;quot; )&amp;quot;

source &lt;span class="nv"&gt;$SCRIPT_DIR&lt;/span&gt;/bin/activate
fab $1 $2

PROJECT=&amp;quot;$(cd $(dirname $0) &lt;span class="err"&gt;&amp;amp;&amp;amp;&lt;/span&gt; pwd)&amp;quot;
source &lt;span class="nv"&gt;$PROJECT&lt;/span&gt;/bin/activate
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;E em seu .bashrc, adicione um alias para ele:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt; alias fagungis=&amp;#39;~/dev/tools/django-fagungis-damianmoore/fagungis.sh&amp;#39;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Agora é só ir até a raiz do seu projeto, onde está salvo o fabfile.py e digitar:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;fagungis simpleproject setup
fagungis simpleproject deploy
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;lembre-se que para as mudanças no .bashrc terem efeito, você deverá recarregá-lo com&lt;/strong&gt; &lt;code&gt;source ~/.bashrc&lt;/code&gt; &lt;strong&gt;ou reabrir a janela do terminal&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Se tudo correu certo, seu projeto já está rodando no servidor. Mas em alguns casos o &lt;a href="http://docs.gunicorn.org/en/latest/run.html"&gt;Gunicorn&lt;/a&gt; tem um problema com a sintaxe antiga e você precisa ir no pacote do fagungis e mudar o último exec do script: &lt;code&gt;~/dev/tools/django-fagungis-damianmoore/lib/python2.7/site-packages/fagungis/scripts/rungunicorn.sh&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;A chamada do gunicorn deve ficar assim:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;exec %(virtenv)s/bin/gunicorn -w %(gunicorn_workers)s \
    --user=%(django_user)s --group=%(django_user_group)s \
    --settings=%(django_project_settings)s \
    --bind=%(gunicorn_bind)s --log-level=%(gunicorn_loglevel)s \
    --log-file=%(gunicorn_logfile)s 2&amp;gt;&amp;gt;%(gunicorn_logfile)s \
    %(project)s.wsgi:application
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Salve o arquivo e tente de novo.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;fagungis simpleproject setup
fagungis simpleproject deploy
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Se seu projeto Django tem a configuração simples, deve estar tudo funcionando. Não esqueça que se você usar pacotes como &lt;a href="https://pypi.python.org/pypi/python-decouple"&gt;python_decouple&lt;/a&gt;, deverá enviar o settings.ini para a pasta do projeto no servidor. &lt;/p&gt;
&lt;p&gt;O Django-Fagungis não cria automaticamente seu servidor de banco de dados, então ainda te resta esssa tarefa, caso ele fique no mesmo servidor do seu projeto. Mas isso fica para um próximo artigo do PythonClub.&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Rômulo Collopy</dc:creator><pubDate>Tue, 13 May 2014 16:00:00 -0300</pubDate><guid>tag:pythonclub.com.br,2014-05-13:deploy-com-django-fagungis.html</guid><category>Django</category><category>Fabric</category><category>Gunicorn</category><category>Nginx</category><category>Supervisor</category><category>Deploy</category><category>django-fagungis</category></item></channel></rss>